{"ast":null,"code":"import _classCallCheck from\"/Users/roaa/Desktop/demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/roaa/Desktop/demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import*as THREE from'three';import TouchTexture from'./TouchTexture';var glslify=require('glslify');var Particles=/*#__PURE__*/function(){function Particles(webgl){_classCallCheck(this,Particles);this.webgl=webgl;this.container=new THREE.Object3D();}_createClass(Particles,[{key:\"init\",value:function init(src){var _this=this;console.log('src: ',src);var loader=new THREE.TextureLoader();console.log('loader: ',loader);loader.load(src,function(texture){console.log('in load');console.log('texture: ',texture);_this.texture=texture;_this.texture.minFilter=THREE.LinearFilter;_this.texture.magFilter=THREE.LinearFilter;_this.texture.format=THREE.RGBFormat;_this.width=texture.image.width;_this.height=texture.image.height;_this.initPoints(true);_this.initHitArea();_this.initTouch();_this.resize();_this.show();});}},{key:\"initPoints\",value:function initPoints(discard){console.log('initPoints');this.numPoints=this.width*this.height;var numVisible=this.numPoints;var threshold=0;var originalColors;if(discard){// discard pixels darker than threshold #22\nnumVisible=0;threshold=34;var img=this.texture.image;console.log('image: ',img);var canvas=document.createElement('canvas');var ctx=canvas.getContext('2d');canvas.width=this.width;canvas.height=this.height;ctx.scale(1,-1);ctx.drawImage(img,0,0,this.width,this.height*-1);var imgData=ctx.getImageData(0,0,canvas.width,canvas.height);originalColors=Float32Array.from(imgData.data);for(var i=0;i<this.numPoints;i++){if(originalColors[i*4+0]>threshold)numVisible++;}// console.log('numVisible', numVisible, this.numPoints);\n}var uniforms={uTime:{value:0},uRandom:{value:1.0},uDepth:{value:2.0},uSize:{value:0.0},uTextureSize:{value:new THREE.Vector2(this.width,this.height)},uTexture:{value:this.texture},uTouch:{value:null}};var material=new THREE.RawShaderMaterial({uniforms:uniforms,vertexShader:glslify(require('../../../shaders/particle.vert')),fragmentShader:glslify(require('../../../shaders/particle.frag')),depthTest:false,transparent:true// blending: THREE.AdditiveBlending\n});var geometry=new THREE.InstancedBufferGeometry();// positions\nvar positions=new THREE.BufferAttribute(new Float32Array(4*3),3);positions.setXYZ(0,-0.5,0.5,0.0);positions.setXYZ(1,0.5,0.5,0.0);positions.setXYZ(2,-0.5,-0.5,0.0);positions.setXYZ(3,0.5,-0.5,0.0);geometry.addAttribute('position',positions);// uvs\nvar uvs=new THREE.BufferAttribute(new Float32Array(4*2),2);uvs.setXYZ(0,0.0,0.0);uvs.setXYZ(1,1.0,0.0);uvs.setXYZ(2,0.0,1.0);uvs.setXYZ(3,1.0,1.0);geometry.addAttribute('uv',uvs);// index\ngeometry.setIndex(new THREE.BufferAttribute(new Uint16Array([0,2,1,2,3,1]),1));var indices=new Uint16Array(numVisible);var offsets=new Float32Array(numVisible*3);var angles=new Float32Array(numVisible);for(var _i=0,j=0;_i<this.numPoints;_i++){if(discard&&originalColors[_i*4+0]<=threshold)continue;offsets[j*3+0]=_i%this.width;offsets[j*3+1]=Math.floor(_i/this.width);indices[j]=_i;angles[j]=Math.random()*Math.PI;j++;}geometry.addAttribute('pindex',new THREE.InstancedBufferAttribute(indices,1,false));geometry.addAttribute('offset',new THREE.InstancedBufferAttribute(offsets,3,false));geometry.addAttribute('angle',new THREE.InstancedBufferAttribute(angles,1,false));this.object3D=new THREE.Mesh(geometry,material);this.container.add(this.object3D);}},{key:\"initTouch\",value:function initTouch(){// create only once\nif(!this.touch)this.touch=new TouchTexture(this);this.object3D.material.uniforms.uTouch.value=this.touch.texture;}},{key:\"initHitArea\",value:function initHitArea(){var geometry=new THREE.PlaneGeometry(this.width,this.height,1,1);var material=new THREE.MeshBasicMaterial({color:0xFFFFFF,wireframe:true,depthTest:false});material.visible=false;this.hitArea=new THREE.Mesh(geometry,material);this.container.add(this.hitArea);}},{key:\"addListeners\",value:function addListeners(){this.handlerInteractiveMove=this.onInteractiveMove.bind(this);this.webgl.interactive.addListener('interactive-move',this.handlerInteractiveMove);this.webgl.interactive.objects.push(this.hitArea);this.webgl.interactive.enable();}},{key:\"removeListeners\",value:function removeListeners(){var _this2=this;this.webgl.interactive.removeListener('interactive-move',this.handlerInteractiveMove);var index=this.webgl.interactive.objects.findIndex(function(obj){return obj===_this2.hitArea;});this.webgl.interactive.objects.splice(index,1);this.webgl.interactive.disable();}// ---------------------------------------------------------------------------------------------\n// PUBLIC\n// ---------------------------------------------------------------------------------------------\n},{key:\"update\",value:function update(delta){if(!this.object3D)return;if(this.touch)this.touch.update();this.object3D.material.uniforms.uTime.value+=delta;}},{key:\"show\",value:function show(){var time=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1.0;// reset\nTweenLite.fromTo(this.object3D.material.uniforms.uSize,time,{value:0.5},{value:1.5});TweenLite.to(this.object3D.material.uniforms.uRandom,time,{value:2.0});TweenLite.fromTo(this.object3D.material.uniforms.uDepth,time*1.5,{value:40.0},{value:4.0});this.addListeners();}},{key:\"hide\",value:function hide(_destroy){var _this3=this;var time=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0.8;console.log('this.object3D: ',this.object3D);return new Promise(function(resolve,reject){TweenLite.to(_this3.object3D.material.uniforms.uRandom,time,{value:5.0,onComplete:function onComplete(){if(_destroy)_this3.destroy();resolve();}});//TweenLite.to(this.object3D.material.uniforms.uDepth, time, { value: -20.0, ease: Quad.easeIn });\nTweenLite.to(_this3.object3D.material.uniforms.uSize,time*0.8,{value:0.0});_this3.removeListeners();});}},{key:\"destroy\",value:function destroy(){if(!this.object3D)return;this.object3D.parent.remove(this.object3D);this.object3D.geometry.dispose();this.object3D.material.dispose();this.object3D=null;if(!this.hitArea)return;this.hitArea.parent.remove(this.hitArea);this.hitArea.geometry.dispose();this.hitArea.material.dispose();this.hitArea=null;}// ---------------------------------------------------------------------------------------------\n// EVENT HANDLERS\n// ---------------------------------------------------------------------------------------------\n},{key:\"resize\",value:function resize(){if(!this.object3D)return;var scale=this.webgl.fovHeight/this.height;this.object3D.scale.set(scale,scale,1);this.hitArea.scale.set(scale,scale,1);}},{key:\"onInteractiveMove\",value:function onInteractiveMove(e){var uv=e.intersectionData.uv;if(this.touch)this.touch.addTouch(uv);}}]);return Particles;}();export{Particles as default};","map":{"version":3,"sources":["/Users/roaa/Desktop/demo/src/scripts/webgl/particles/Particles.js"],"names":["THREE","TouchTexture","glslify","require","Particles","webgl","container","Object3D","src","console","log","loader","TextureLoader","load","texture","minFilter","LinearFilter","magFilter","format","RGBFormat","width","image","height","initPoints","initHitArea","initTouch","resize","show","discard","numPoints","numVisible","threshold","originalColors","img","canvas","document","createElement","ctx","getContext","scale","drawImage","imgData","getImageData","Float32Array","from","data","i","uniforms","uTime","value","uRandom","uDepth","uSize","uTextureSize","Vector2","uTexture","uTouch","material","RawShaderMaterial","vertexShader","fragmentShader","depthTest","transparent","geometry","InstancedBufferGeometry","positions","BufferAttribute","setXYZ","addAttribute","uvs","setIndex","Uint16Array","indices","offsets","angles","j","Math","floor","random","PI","InstancedBufferAttribute","object3D","Mesh","add","touch","PlaneGeometry","MeshBasicMaterial","color","wireframe","visible","hitArea","handlerInteractiveMove","onInteractiveMove","bind","interactive","addListener","objects","push","enable","removeListener","index","findIndex","obj","splice","disable","delta","update","time","TweenLite","fromTo","to","addListeners","_destroy","Promise","resolve","reject","onComplete","destroy","removeListeners","parent","remove","dispose","fovHeight","set","e","uv","intersectionData","addTouch"],"mappings":"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","sourcesContent":["import * as THREE from 'three';\n\nimport TouchTexture from './TouchTexture';\n\nconst glslify = require('glslify');\n\nexport default class Particles {\n\t\n\tconstructor(webgl) {\n\t\tthis.webgl = webgl;\n\t\tthis.container = new THREE.Object3D();\n\t}\n\n\tinit(src) {\n\t\tconsole.log('src: ', src)\n\t\tconst loader = new THREE.TextureLoader();\n\t\tconsole.log('loader: ', loader)\n\n\t\tloader.load(src, (texture) => {\n\t\t\tconsole.log('in load')\n\t\t\tconsole.log('texture: ', texture)\n\t\t\tthis.texture = texture;\n\t\t\tthis.texture.minFilter = THREE.LinearFilter;\n\t\t\tthis.texture.magFilter = THREE.LinearFilter;\n\t\t\tthis.texture.format = THREE.RGBFormat;\n\n\t\t\tthis.width = texture.image.width;\n\t\t\tthis.height = texture.image.height;\n\n\t\t\tthis.initPoints(true);\n\t\t\tthis.initHitArea();\n\t\t\tthis.initTouch();\n\t\t\tthis.resize();\n\t\t\tthis.show();\n\t\t});\n\t}\n\n\tinitPoints(discard) {\n\t\tconsole.log('initPoints')\n\t\tthis.numPoints = this.width * this.height;\n\n\t\tlet numVisible = this.numPoints;\n\t\tlet threshold = 0;\n\t\tlet originalColors;\n\n\t\tif (discard) {\n\t\t\t// discard pixels darker than threshold #22\n\t\t\tnumVisible = 0;\n\t\t\tthreshold = 34;\n\n\t\t\tconst img = this.texture.image;\n\t\t\tconsole.log('image: ', img)\n\t\t\tconst canvas = document.createElement('canvas');\n\t\t\tconst ctx = canvas.getContext('2d');\n\n\t\t\tcanvas.width = this.width;\n\t\t\tcanvas.height = this.height;\n\t\t\tctx.scale(1, -1);\n\t\t\tctx.drawImage(img, 0, 0, this.width, this.height * -1);\n\n\t\t\tconst imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n\t\t\toriginalColors = Float32Array.from(imgData.data);\n\n\t\t\tfor (let i = 0; i < this.numPoints; i++) {\n\t\t\t\tif (originalColors[i * 4 + 0] > threshold) numVisible++;\n\t\t\t}\n\n\t\t\t// console.log('numVisible', numVisible, this.numPoints);\n\t\t}\n\n\t\tconst uniforms = {\n\t\t\tuTime: { value: 0 },\n\t\t\tuRandom: { value: 1.0 },\n\t\t\tuDepth: { value: 2.0 },\n\t\t\tuSize: { value: 0.0 },\n\t\t\tuTextureSize: { value: new THREE.Vector2(this.width, this.height) },\n\t\t\tuTexture: { value: this.texture },\n\t\t\tuTouch: { value: null },\n\t\t};\n\n\t\tconst material = new THREE.RawShaderMaterial({\n\t\t\tuniforms,\n\t\t\tvertexShader: glslify(require('../../../shaders/particle.vert')),\n\t\t\tfragmentShader: glslify(require('../../../shaders/particle.frag')),\n\t\t\tdepthTest: false,\n\t\t\ttransparent: true,\n\t\t\t// blending: THREE.AdditiveBlending\n\t\t});\n\n\t\tconst geometry = new THREE.InstancedBufferGeometry();\n\n\t\t// positions\n\t\tconst positions = new THREE.BufferAttribute(new Float32Array(4 * 3), 3);\n\t\tpositions.setXYZ(0, -0.5,  0.5,  0.0);\n\t\tpositions.setXYZ(1,  0.5,  0.5,  0.0);\n\t\tpositions.setXYZ(2, -0.5, -0.5,  0.0);\n\t\tpositions.setXYZ(3,  0.5, -0.5,  0.0);\n\t\tgeometry.addAttribute('position', positions);\n\n\t\t// uvs\n\t\tconst uvs = new THREE.BufferAttribute(new Float32Array(4 * 2), 2);\n\t\tuvs.setXYZ(0,  0.0,  0.0);\n\t\tuvs.setXYZ(1,  1.0,  0.0);\n\t\tuvs.setXYZ(2,  0.0,  1.0);\n\t\tuvs.setXYZ(3,  1.0,  1.0);\n\t\tgeometry.addAttribute('uv', uvs);\n\n\t\t// index\n\t\tgeometry.setIndex(new THREE.BufferAttribute(new Uint16Array([ 0, 2, 1, 2, 3, 1 ]), 1));\n\n\t\tconst indices = new Uint16Array(numVisible);\n\t\tconst offsets = new Float32Array(numVisible * 3);\n\t\tconst angles = new Float32Array(numVisible);\n\n\t\tfor (let i = 0, j = 0; i < this.numPoints; i++) {\n\t\t\tif (discard && originalColors[i * 4 + 0] <= threshold) continue;\n\n\t\t\toffsets[j * 3 + 0] = i % this.width;\n\t\t\toffsets[j * 3 + 1] = Math.floor(i / this.width);\n\n\t\t\tindices[j] = i;\n\n\t\t\tangles[j] = Math.random() * Math.PI;\n\n\t\t\tj++;\n\t\t}\n\n\t\tgeometry.addAttribute('pindex', new THREE.InstancedBufferAttribute(indices, 1, false));\n\t\tgeometry.addAttribute('offset', new THREE.InstancedBufferAttribute(offsets, 3, false));\n\t\tgeometry.addAttribute('angle', new THREE.InstancedBufferAttribute(angles, 1, false));\n\n\t\tthis.object3D = new THREE.Mesh(geometry, material);\n\t\tthis.container.add(this.object3D);\n\t}\n\n\tinitTouch() {\n\t\t// create only once\n\t\tif (!this.touch) this.touch = new TouchTexture(this);\n\t\tthis.object3D.material.uniforms.uTouch.value = this.touch.texture;\n\t}\n\n\tinitHitArea() {\n\t\tconst geometry = new THREE.PlaneGeometry(this.width, this.height, 1, 1);\n\t\tconst material = new THREE.MeshBasicMaterial({ color: 0xFFFFFF, wireframe: true, depthTest: false });\n\t\tmaterial.visible = false;\n\t\tthis.hitArea = new THREE.Mesh(geometry, material);\n\t\tthis.container.add(this.hitArea);\n\t}\n\n\taddListeners() {\n\t\tthis.handlerInteractiveMove = this.onInteractiveMove.bind(this);\n\n\t\tthis.webgl.interactive.addListener('interactive-move', this.handlerInteractiveMove);\n\t\tthis.webgl.interactive.objects.push(this.hitArea);\n\t\tthis.webgl.interactive.enable();\n\t}\n\n\tremoveListeners() {\n\t\tthis.webgl.interactive.removeListener('interactive-move', this.handlerInteractiveMove);\n\t\t\n\t\tconst index = this.webgl.interactive.objects.findIndex(obj => obj === this.hitArea);\n\t\tthis.webgl.interactive.objects.splice(index, 1);\n\t\tthis.webgl.interactive.disable();\n\t}\n\n\t// ---------------------------------------------------------------------------------------------\n\t// PUBLIC\n\t// ---------------------------------------------------------------------------------------------\n\n\tupdate(delta) {\n\t\tif (!this.object3D) return;\n\t\tif (this.touch) this.touch.update();\n\n\t\tthis.object3D.material.uniforms.uTime.value += delta;\n\t}\n\n\tshow(time = 1.0) {\n\t\t// reset\n\t\tTweenLite.fromTo(this.object3D.material.uniforms.uSize, time, { value: 0.5 }, { value: 1.5 });\n\t\tTweenLite.to(this.object3D.material.uniforms.uRandom, time, { value: 2.0 });\n\t\tTweenLite.fromTo(this.object3D.material.uniforms.uDepth, time * 1.5, { value: 40.0 }, { value: 4.0 });\n\n\t\tthis.addListeners();\n\t}\n\n\thide(_destroy, time = 0.8) {\n\t\tconsole.log('this.object3D: ', this.object3D)\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tTweenLite.to(this.object3D.material.uniforms.uRandom, time, { value: 5.0, onComplete: () => {\n\t\t\t\tif (_destroy) this.destroy();\n\t\t\t\tresolve();\n\t\t\t} });\n\t\t\t//TweenLite.to(this.object3D.material.uniforms.uDepth, time, { value: -20.0, ease: Quad.easeIn });\n\t\t\tTweenLite.to(this.object3D.material.uniforms.uSize, time * 0.8, { value: 0.0 });\n\n\t\t\tthis.removeListeners();\n\t\t});\n\t}\n\n\tdestroy() {\n\t\tif (!this.object3D) return;\n\n\t\tthis.object3D.parent.remove(this.object3D);\n\t\tthis.object3D.geometry.dispose();\n\t\tthis.object3D.material.dispose();\n\t\tthis.object3D = null;\n\n\t\tif (!this.hitArea) return;\n\n\t\tthis.hitArea.parent.remove(this.hitArea);\n\t\tthis.hitArea.geometry.dispose();\n\t\tthis.hitArea.material.dispose();\n\t\tthis.hitArea = null;\n\t}\n\n\t// ---------------------------------------------------------------------------------------------\n\t// EVENT HANDLERS\n\t// ---------------------------------------------------------------------------------------------\n\n\tresize() {\n\t\tif (!this.object3D) return;\n\n\t\tconst scale = this.webgl.fovHeight / this.height;\n\t\tthis.object3D.scale.set(scale, scale, 1);\n\t\tthis.hitArea.scale.set(scale, scale, 1);\n\t}\n\n\tonInteractiveMove(e) {\n\t\tconst uv = e.intersectionData.uv;\n\t\tif (this.touch) this.touch.addTouch(uv);\n\t}\n}\n"]},"metadata":{},"sourceType":"module"}